<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Signage Player</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: black;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

#video, #image, #pdf {
    position: absolute;
    width: 100%;
    height: 100%;
    display: none;
    object-fit: contain;
    background: black;
}
</style>
</head>

<body>

<video id="video" muted autoplay></video>
<img id="image">
<iframe id="pdf"></iframe>

<script>
/* ================= CONFIG ================= */
const params = new URLSearchParams(window.location.search);
const DEVICE_ID = params.get("device");

if (!DEVICE_ID) {
    alert("DEVICE_ID missing in URL");
}

const WS_URL =
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/ws/" + DEVICE_ID;

/* ================= ELEMENTS ================= */
const video = document.getElementById("video");
const image = document.getElementById("image");
const pdf   = document.getElementById("pdf");

/* ================= STATE ================= */
let playlist = [];
let index = 0;
let timer = null;
let ws = null;

/* ================= WEBSOCKET ================= */
function connectWS() {
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        console.log("âœ… WebSocket connected");
    };

    ws.onmessage = (event) => {
        try {
            playlist = JSON.parse(event.data);
            index = 0;
            clearTimeout(timer);
            playNext();
        } catch (e) {
            console.error("Invalid playlist data", e);
        }
    };

    ws.onclose = () => {
        console.log("âŒ WS disconnected, retrying...");
        setTimeout(connectWS, 3000);
    };
}

connectWS();

/* ================= HELPERS ================= */
function hideAll() {
    video.pause();
    video.removeAttribute("src");
    video.load();

    video.style.display = "none";
    image.style.display = "none";
    pdf.style.display = "none";

    clearTimeout(timer);
}

// ðŸ”¥ notify backend AFTER full display
function notifyShow(itemId) {
    fetch("/api/playlist/increment-show", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            deviceId: DEVICE_ID,
            itemId: itemId
        })
    }).catch(() => {});
}

/* ================= PLAYER ================= */
function playNext() {
    if (!playlist || playlist.length === 0) return;

    hideAll();

    const item = playlist[index];
    const duration = (item.duration || 10) * 1000;

    console.log("â–¶ Playing:", item);

    /* ===== VIDEO ===== */
    if (item.type === "videos") {
        video.src = item.url;
        video.style.display = "block";
        video.currentTime = 0;
        video.play();

        video.onended = () => {
            notifyShow(item.id);   // âœ… FULL VIDEO PLAYED
            nextIndex();
            playNext();
        };

    /* ===== IMAGE ===== */
    } else if (item.type === "images") {
        image.src = item.url;
        image.style.display = "block";

        timer = setTimeout(() => {
            notifyShow(item.id);   // âœ… AFTER FULL DURATION
            nextIndex();
            playNext();
        }, duration);

    /* ===== PDF ===== */
    } else if (item.type === "pdfs") {
        pdf.src = item.url;
        pdf.style.display = "block";

        timer = setTimeout(() => {
            notifyShow(item.id);   
            nextIndex();
            playNext();
        }, duration);
    }
}

function nextIndex() {
    index++;
    if (index >= playlist.length) index = 0;
}
</script>

</body>
</html>
